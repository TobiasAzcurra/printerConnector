@echo off
title TicketConnector - Instalador Automatico v2.1
color 0A
echo.
echo  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
echo  ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë   
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   
echo     ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   
echo  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
echo ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
echo ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
echo ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
echo ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
echo  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
echo.
echo ========================================================================
echo  INSTALADOR AUTOMATICO - Sistema de Impresion Termica Profesional
echo  Version 2.1 - Conabsolute Soluciones Empresariales
echo ========================================================================
echo.

REM Verificar permisos de administrador
echo [1/11] Verificando permisos de administrador...
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo ‚ùå ERROR: Se requieren permisos de administrador
    echo.
    echo Por favor:
    echo 1. Cierra esta ventana
    echo 2. Clic derecho en install-automatico.bat
    echo 3. Selecciona "Ejecutar como administrador"
    echo.
    pause
    exit /b
)
echo ‚úÖ Permisos de administrador verificados

REM Verificar Node.js
echo.
echo [2/11] Verificando Node.js...
node --version >nul 2>&1
if %errorLevel% neq 0 (
    echo ‚ùå Node.js no encontrado
    echo.
    echo DESCARGANDO E INSTALANDO NODE.JS...
    echo Por favor espera mientras se descarga...
    
    REM Descargar Node.js
    powershell -Command "(New-Object System.Net.WebClient).DownloadFile('https://nodejs.org/dist/v18.17.0/node-v18.17.0-x64.msi', '%TEMP%\nodejs.msi')"
    
    REM Instalar silenciosamente
    msiexec /i "%TEMP%\nodejs.msi" /quiet /norestart
    
    REM Actualizar PATH
    setx PATH "%PATH%;C:\Program Files\nodejs\" /M >nul
    set "PATH=%PATH%;C:\Program Files\nodejs\"
    
    echo ‚úÖ Node.js instalado correctamente
) else (
    echo ‚úÖ Node.js ya est√° instalado
)

REM Cambiar al directorio del proyecto
echo.
echo [3/11] Configurando directorio de trabajo...
cd /d "%~dp0"
echo ‚úÖ Directorio: %CD%

REM Limpiar instalaciones previas
echo.
echo [4/11] Limpiando instalaciones previas...
taskkill /f /im "node.exe" >nul 2>&1
taskkill /f /im "pm2*" >nul 2>&1
if exist "%USERPROFILE%\.pm2" (
    rmdir /s /q "%USERPROFILE%\.pm2" >nul 2>&1
)
echo ‚úÖ Limpieza completada

REM Instalar dependencias del proyecto
echo.
echo [5/11] Instalando dependencias del proyecto...
call npm install --silent
echo ‚úÖ Dependencias instaladas

REM Instalar PM2
echo.
echo [6/11] Instalando gestor de servicios PM2...
call npm uninstall -g pm2 >nul 2>&1
call npm install -g pm2@latest --silent
call npm install -g pm2-windows-startup --silent
echo ‚úÖ PM2 instalado

REM Crear configuraci√≥n inicial b√°sica
echo.
echo [7/11] Generando configuraci√≥n inicial...
echo { > config.json
echo   "clienteId": "%COMPUTERNAME%-printer", >> config.json
echo   "printerIP": "192.168.1.100", >> config.json
echo   "printerPort": 9100, >> config.json
echo   "businessName": "Mi Negocio", >> config.json
echo   "ticketWidth": 48, >> config.json
echo   "useHeaderLogo": true, >> config.json
echo   "useFooterLogo": true, >> config.json
echo   "useFontTicket": false >> config.json
echo } >> config.json
echo ‚úÖ Configuraci√≥n inicial generada

REM Iniciar servicios
echo.
echo [8/11] Iniciando servicios...
call pm2 start web\server.js --name "ticket-web-server" >nul
call pm2 start index.js --name "ticket-service" >nul
call pm2 save >nul
call pm2-startup install >nul
echo ‚úÖ Servicios iniciados y configurados para autoarranque

REM NUEVO: Auto-detecci√≥n inteligente de impresoras
echo.
echo [9/11] Detectando impresoras autom√°ticamente...
if exist "auto-config.js" (
    echo üîç Ejecutando detecci√≥n autom√°tica de impresoras...
    call node auto-config.js
    if %errorLevel% equ 0 (
        echo ‚úÖ Impresora detectada y configurada autom√°ticamente
    ) else (
        echo ‚ö†Ô∏è Auto-detecci√≥n completada - verifica configuraci√≥n en interfaz web
    )
) else (
    echo ‚ö†Ô∏è Auto-configurador no encontrado - configuraci√≥n manual requerida
)

REM Verificar instalaci√≥n
echo.
echo [10/11] Verificando instalaci√≥n...
timeout /t 2 >nul
call pm2 status
echo.

REM Abrir configuraci√≥n autom√°ticamente
echo.
echo [11/11] Abriendo interfaz de configuraci√≥n...
start http://localhost:4040

REM Leer configuraci√≥n final para mostrar IP detectada
echo ‚úÖ Leyendo configuraci√≥n final...
if exist "config.json" (
    for /f "tokens=2 delims=:" %%a in ('findstr "printerIP" config.json') do (
        set "FINAL_IP=%%a"
        set "FINAL_IP=!FINAL_IP:~2,-2!"
    )
)

echo.
echo ========================================================================
echo  üéâ INSTALACION COMPLETADA EXITOSAMENTE üéâ
echo ========================================================================
echo.
echo ‚úÖ Servicios corriendo en segundo plano
echo ‚úÖ Configuraci√≥n web: http://localhost:4040
echo ‚úÖ Auto-inicio con Windows configurado
if defined FINAL_IP (
    echo ‚úÖ Impresora configurada: %FINAL_IP%
) else (
    echo ‚ö†Ô∏è Verifica la IP de tu impresora en la interfaz web
)
echo.
echo PROXIMOS PASOS:
echo 1. La interfaz web se abrir√° autom√°ticamente
echo 2. Verifica la configuraci√≥n en la pesta√±a "Conexi√≥n"  
echo 3. Haz una prueba de impresi√≥n
echo 4. ¬°Ya puedes usar el sistema!
echo.
echo ARCHIVOS DE SOPORTE:
echo - status.bat: Ver estado del sistema
echo - ver-logs.bat: Ver registros de error  
echo - uninstall.bat: Desinstalar completamente
echo.
echo Para soporte: https://conabsolute.com
echo ========================================================================
pause